---
title: "Capacity Analysis Visualizations"
author: "Kate Houston"
format: 
  html:
    self-contained: True
editor: visual
---

## Priority Analysis Visualizations

```{r}
library(tidyverse)
library(readr)
library(colorspace)    ## adjust colors
library(ggforce)       ## sina plots
library(ggdist)        ## halfeye plots
library(ggridges)      ## ridgeline plots
library(ggbeeswarm)    ## beeswarm plots
library(gghalves)      ## off-set jitter
library(systemfonts)   ## custom fonts
```

```{r}
results <- read_csv("results/results_capacity.csv", show_col_types = FALSE)
cahoots <- read_csv("data/busy_log.csv", show_col_types = FALSE)
epd <- read_csv("data/epd_with_capacity.csv", show_col_types = FALSE)
results
```

```{r}
cahoots
```

```{r}
cahoots |> 
  mutate(
    capacity_status = if_else(capacity == 0, "Available", "Full"),
    arrival_time_min = secs_to_arrv / 60
  ) |>
  filter(!is.na(capacity_status)) |>
  ggplot(aes(x = capacity_status, y = arrival_time_min, fill = capacity_status)) +
  geom_violin(trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.6) +
  labs(
    title = "CAHOOTS Arrival Time Distribution by Capacity Status",
    x = "Capacity Status", y = "Arrival Time (minutes)"
  ) +
  theme_minimal()

```

```{r}
cahoots |>
  mutate(
    capacity_status = if_else(capacity == 0, "Available", "Full"),
    arrival_time_min = secs_to_arrv / 60
  ) |>
  filter(!is.na(capacity_status)) |>
  ggplot(aes(x = arrival_time_min, color = capacity_status)) +
  stat_ecdf(geom = "step") +
  coord_cartesian(xlim = c(0, 120)) +
  labs(
    title = "Cumulative Arrival Time by CAHOOTS Capacity",
    x = "Arrival Time (minutes)", y = "Proportion of Calls",
    color = "Capacity Status"
  ) +
  theme_minimal()

```

\*\* red line consistently to the left \*\*

cahoots faster when vans avail

```{r}
epd_sub <- read_csv("results/epd_nature_sub.csv", show_col_types = FALSE)
```

```{r}
epd |>
  filter(!is.na(cahoots_at_capacity)) |>
  filter(!is.na(priority)) |>
  mutate(
    capacity_status = if_else(cahoots_at_capacity == 0, "Available", "Full"),
    arrival_time_min = secs_to_arrv / 60,
    priority = factor(priority, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "P"))
  ) |>
  group_by(priority, capacity_status) |>
  summarize(mean_arrival = mean(arrival_time_min, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = priority, y = mean_arrival, group = capacity_status, color = capacity_status)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  labs(
    title = "Mean EPD Arrival Time by Priority and CAHOOTS Capacity",
    x = "Call Priority", y = "Median Arrival Time (minutes)",
    color = "CAHOOTS Capacity"
  ) +
  theme_minimal()

```

```{r}
epd_summary <- epd |>
  filter(!is.na(cahoots_at_capacity), !is.na(priority)) |>
  mutate(
    capacity_status = if_else(cahoots_at_capacity == 0, "Available", "Full"),
    arrival_time_min = secs_to_arrv / 60,
    priority = factor(priority, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "P"))
  ) |>
  group_by(priority, capacity_status) |>
  summarize(median_arrival = median(arrival_time_min, na.rm = TRUE), .groups = "drop")

```

```{r}
ggplot(epd_summary, aes(x = priority, y = median_arrival, fill = capacity_status)) +
  geom_col(position = "dodge") +
  labs(
    title = "Median EPD Arrival Time by Priority and CAHOOTS Capacity",
    x = "Call Priority", y = "Median Arrival Time (minutes)",
    fill = "CAHOOTS Capacity"
  ) +
  theme_minimal()

```

```{r}
ggplot(epd_summary, aes(x = priority, y = median_arrival, color = capacity_status)) +
  geom_point(position = position_dodge(width = 0.5), size = 4) +
  labs(
    title = "Median EPD Arrival Time by Priority and CAHOOTS Capacity",
    x = "Call Priority", y = "Median Arrival Time (minutes)",
    color = "CAHOOTS Capacity"
  ) +
  theme_minimal()

```

```{r}
ggplot(epd_summary, aes(x = priority, y = median_arrival, color = capacity_status)) +
  geom_line(aes(group = capacity_status), size = 1) +
  facet_wrap(~capacity_status) +
  labs(title = "EPD Arrival Time by Priority and CAHOOTS Capacity (Interaction View)")

```

```{r}
library(ggalt)

ggplot(epd_summary |> pivot_wider(names_from = capacity_status, values_from = median_arrival),
       aes(x = Available, xend = Full, y = priority)) +
  geom_dumbbell(color = "gray", size = 2, colour_x = "red", colour_xend = "blue") +
  labs(title = "EPD Arrival Time by CAHOOTS Capacity", x = "Arrival Time (min)", y = "Priority")

```
